<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stats Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- HEADER -->
  <header>
    <nav>
      <div class="nav-icon">
        <a href="index.html">
          <img src="icono.png" alt="Logo" style="height:70px">
        </a>
      </div>
      <div class="nav-links">
        <a href="lista.html">Lista de Niveles</a>
        <a href="statsviewer.html" class="active">Stats Viewer</a>
      </div>
    </nav>
  </header>

  <div class="jugadores-container">
    <div class="panel-jugadores" id="panel-jugadores">
      <h1>Ranking de Jugadores</h1>
    </div>
  </div>

  <script>
    const panelJugadores = document.getElementById('panel-jugadores');

    fetch('niveles.csv')
      .then(r => r.text())
      .then(csv => {
        const lines = csv.trim().split('\n');
        lines.shift(); // quitar cabecera

        const niveles = lines.map(line => {
          const cols = line.split(';');
          return {
            url: cols[1],
            titulo: cols[2],
            creador: cols[3],
            ranchopoints: parseFloat(cols[4]) || 0,
            jugadores: cols[4] ? cols[4].split(',').map(j => j.trim()) : [] // <-- vamos a ajustar
          };
        });

        // Crear objeto de jugadores
        const jugadores = {};

        niveles.forEach(nivel => {
          // Si la columna de jugadores no está vacía
          if (nivel.jugadores.length > 0 && nivel.jugadores[0] !== "") {
            nivel.jugadores.forEach(j => {
              // Separar nombre y url de video
              const [nombre, video] = j.split('|').map(s => s.trim());
              if (!jugadores[nombre]) jugadores[nombre] = { nombre, total: 0, niveles: [] };
              jugadores[nombre].total += nivel.ranchopoints;
              jugadores[nombre].niveles.push({ titulo: nivel.titulo, ranchopoints: nivel.ranchopoints, urlVideo: video });
            });
          }
        });

        // Ordenar por puntos
        const ranking = Object.values(jugadores).sort((a,b) => b.total - a.total);

        // Mostrar ranking
        ranking.forEach(jugador => {
          const divJugador = document.createElement('div');
          divJugador.classList.add('jugador');
          divJugador.innerHTML = `<h2>${jugador.nombre} — ${jugador.total.toFixed(2)} pts</h2>`;
          divJugador.addEventListener('click', () => mostrarPerfil(jugador));
          panelJugadores.appendChild(divJugador);
        });

        function mostrarPerfil(jugador) {
          const perfilPrevio = document.querySelector('.perfil');
          if (perfilPrevio) perfilPrevio.remove();

          const perfil = document.createElement('div');
          perfil.classList.add('perfil');
          perfil.innerHTML = `<h2>Niveles superados por ${jugador.nombre}</h2>`;

          jugador.niveles.forEach(nivel => {
            const nivelDiv = document.createElement('div');
            nivelDiv.classList.add('nivel');

            const thumb = document.createElement('div');
            thumb.classList.add('thumb');

            // Imagen de miniatura de YouTube desde urlVideo
            let videoId = null;
            try {
              const urlObj = new URL(nivel.urlVideo);
              if (urlObj.hostname.includes('youtu.be')) videoId = urlObj.pathname.slice(1);
              else if (urlObj.hostname.includes('youtube.com')) videoId = urlObj.searchParams.get('v');
            } catch(e){ console.warn('URL inválida:', nivel.urlVideo); }

            if(videoId) {
              thumb.style.backgroundImage = `url('https://img.youtube.com/vi/${videoId}/mqdefault.jpg')`;
            }

            const info = document.createElement('div');
            info.classList.add('demon-info');
            info.innerHTML = `<strong>${nivel.titulo}</strong><br>Ranchopoints: ${nivel.ranchopoints}`;

            nivelDiv.appendChild(thumb);
            nivelDiv.appendChild(info);
            perfil.appendChild(nivelDiv);
          });

          panelJugadores.appendChild(perfil);
        }

      });
  </script>
</body>
</html>


