<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stats Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- HEADER -->
  <header>
    <nav>
      <div class="nav-icon">
        <a href="index.html">
          <img src="icono.png" alt="Logo" style="height:70px">
        </a>
      </div>
      <div class="nav-links">
        <a href="lista.html">Lista de Niveles</a>
        <a href="statsviewer.html" class="active">Stats Viewer</a>
      </div>
    </nav>
  </header>

  <div class="jugadores-container">
    <div class="panel-jugadores" id="panel-jugadores">
      <h1>Ranking de Jugadores</h1>
    </div>
  </div>

  <script>
    const panelJugadores = document.getElementById('panel-jugadores');

    fetch('niveles.csv')
      .then(r => r.text())
      .then(csv => {
        const lines = csv.trim().split('\n');
        lines.shift(); // eliminar cabecera

        // Mapear niveles con las columnas correctas
        const niveles = lines.map(line => {
          const cols = line.split(';');
          return {
            url: cols[0],
            titulo: cols[1],
            creador: cols[2],
            ranchopoints: parseFloat(cols[3]) || 0,
            jugadores: cols[4] ? cols[4].split(',').map(j => j.trim()) : []
          };
        });

        // Crear objeto de jugadores agregando sus puntos y niveles
        const jugadores = {};
        niveles.forEach(nivel => {
          nivel.jugadores.forEach(nombre => {
            if (!jugadores[nombre]) jugadores[nombre] = { nombre, total: 0, niveles: [] };
            jugadores[nombre].total += nivel.ranchopoints;
            jugadores[nombre].niveles.push(nivel);
          });
        });

        // Ordenar por puntos
        const ranking = Object.values(jugadores).sort((a,b) => b.total - a.total);

        // Mostrar lista de jugadores
        ranking.forEach(jugador => {
          const divJugador = document.createElement('div');
          divJugador.classList.add('jugador');
          divJugador.innerHTML = `<h2>${jugador.nombre} — ${jugador.total.toFixed(2)} pts</h2>`;
          divJugador.addEventListener('click', () => mostrarPerfil(jugador));
          panelJugadores.appendChild(divJugador);
        });

        // Función para mostrar el perfil del jugador
        function mostrarPerfil(jugador) {
          const perfilPrevio = document.querySelector('.perfil');
          if (perfilPrevio) perfilPrevio.remove();

          const perfil = document.createElement('div');
          perfil.classList.add('perfil');
          perfil.innerHTML = `<h2>Niveles superados por ${jugador.nombre}</h2>`;

          jugador.niveles.forEach(nivel => {
            const videoIdMatch = nivel.url.match(/(?:youtu\.be\/|v=)([\w-]+)/);
            const videoId = videoIdMatch ? videoIdMatch[1] : null;
            const thumbUrl = videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : '';

            const nivelDiv = document.createElement('div');
            nivelDiv.classList.add('nivel');

            const thumb = document.createElement('div');
            thumb.classList.add('thumb');
            if(thumbUrl) thumb.style.backgroundImage = `url('${thumbUrl}')`;

            const info = document.createElement('div');
            info.classList.add('demon-info');
            info.innerHTML = `<strong>${nivel.titulo}</strong><br>Ranchopoints: ${nivel.ranchopoints}<br>Creador: ${nivel.creador}`;

            nivelDiv.appendChild(thumb);
            nivelDiv.appendChild(info);
            perfil.appendChild(nivelDiv);
          });

          panelJugadores.appendChild(perfil);
        }

      })
      .catch(err => {
        console.error('Error cargando CSV:', err);
        panelJugadores.innerHTML = "<p>Error al cargar los datos de los jugadores.</p>";
      });
  </script>
</body>
</html>

